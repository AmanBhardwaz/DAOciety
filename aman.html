<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tender Voting (Favour / Against)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
 <style>
  body {
  font-family: 'Segoe UI', Roboto, sans-serif;
  margin: 40px;
  background: linear-gradient(135deg, #e0f7fa, #f1f8ff);
  color: #1e293b;
}

header {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 40px;
}

h2 {
  font-size: 36px;
  font-weight: 800;
  color: #0f172a;
}

button {
  cursor: pointer;
  padding: 14px 22px;
  border-radius: 14px;
  border: none;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
}

.connect {
  background: linear-gradient(to right, #0f172a, #334155);
  color: #fff;
  border: 1px solid #475569;
}

.connect:hover {
  background: linear-gradient(to right, #1e293b, #475569);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 32px;
}

.card {
  background: rgba(255, 255, 255, 0.6);
  border-radius: 24px;
  padding: 28px;
  backdrop-filter: blur(12px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-6px);
}

.title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 10px;
  color: #0f172a;
}

.desc {
  font-size: 16px;
  color: #475569;
  margin-bottom: 18px;
}

.row {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.pill {
  font-size: 14px;
  background: linear-gradient(to right, #e2e8f0, #f1f5f9);
  padding: 8px 14px;
  border-radius: 999px;
  color: #334155;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

.vote {
  display: flex;
  gap: 14px;
  align-items: center;
  margin-top: 16px;
}

.ok {
  background: linear-gradient(to right, #0ea5e9, #38bdf8);
  color: #fff;
  box-shadow: 0 0 8px rgba(14, 165, 233, 0.4);
}

.ok:hover {
  background: linear-gradient(to right, #0284c7, #0ea5e9);
  box-shadow: 0 0 12px rgba(14, 165, 233, 0.6);
}

.no {
  background: linear-gradient(to right, #ef4444, #f87171);
  color: #fff;
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
}

.no:hover {
  background: linear-gradient(to right, #dc2626, #ef4444);
  box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
}

.count {
  font-size: 14px;
  color: #64748b;
  margin-left: auto;
}

.small {
  font-size: 14px;
  color: #64748b;
}
</style>
    <script src="public/js/localStorageManager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <header>
    <h2 style="margin:0;">Tender Voting</h2>
    <button id="connectBtn" class="connect">Connect MetaMask</button>
    <span id="status" class="small">Not connected</span>
  </header>

  <div class="grid" id="cards"></div>

  <script>
    // ===== 1) CONFIG: put your contract details here =====
    const CONTRACT_ADDRESS = "0xf8e81D47203A594245E36C48e151709F0C19fBe8";
    const CONTRACT_ABI = [ // replace this ABI with your actual ABI array
      "function vote(string memory candidate) public",
      "function getVotes(string memory candidate) public view returns (uint256)"
    ];

    const TENDERS = [
      { id: "Tender1", title: "Road Repair (Ward 14)", amount: "₹48,00,000", deadline: "2025-10-01", desc: "Resurfacing 3.2 km, hot mix." },
      { id: "Tender2", title: "School Roof Renovation", amount: "₹22,50,000", deadline: "2025-09-15", desc: "Replace asbestos with metal sheets." },
      { id: "Tender3", title: "Smart Lights – Phase II", amount: "₹1,05,00,000", deadline: "2025-09-30", desc: "Install 500 LED poles with CMS." }
    ];

    // ===== 2) Web3 wiring =====
    let provider, signer, contract;

    async function connect() {
      if (!window.ethereum) {
        alert("MetaMask not found. Install it first.");
        return;
      }
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const addr = await signer.getAddress();
        document.getElementById("status").textContent = "Connected ✅ " + addr.slice(0, 6) + "..." + addr.slice(-4);
        await renderAllCounts();
      } catch (err) {
        console.error("MetaMask connection error:", err);
        alert("Connection failed.");
      }
    }

    document.getElementById("connectBtn").onclick = connect;

    // ===== 3) UI rendering =====
    const cardsDiv = document.getElementById("cards");

    function makeCard(t) {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="title">${t.title}</div>
        <div class="desc">${t.desc}</div>
        <div class="row">
          <span class="pill">Amount: ${t.amount}</span>
          <span class="pill">Deadline: ${t.deadline}</span>
        </div>
        <div class="vote">
          <button class="ok" id="fav-${t.id}">Favour</button>
          <button class="no" id="ag-${t.id}">Against</button>
          <span class="count" id="counts-${t.id}">Favour: … | Against: …</span>
        </div>
      `;
      el.querySelector("#fav-" + t.id).onclick = () => voteTender(t.id, "Favour");
      el.querySelector("#ag-" + t.id).onclick = () => voteTender(t.id, "Against");
      return el;
    }

    function renderCards() {
      cardsDiv.innerHTML = "";
      TENDERS.forEach(t => cardsDiv.appendChild(makeCard(t)));
    }

    renderCards();

    // ===== 4) Contract helpers =====
    function key(id, side) {
      return `${id}-${side}`; // matches the way the contract expects vote keys
    }

    async function voteTender(id, side) {
      if (!contract) {
        alert("Connect MetaMask first.");
        return;
      }
      try {
        const tx = await contract.vote(key(id, side));
        document.getElementById("status").textContent = "Submitting tx… " + tx.hash.slice(0, 10) + "…";
        await tx.wait();
        document.getElementById("status").textContent = "Vote recorded ✅";
        await updateCounts(id);
      } catch (e) {
        console.error(e);
        alert(e?.data?.message || e?.message || "Transaction failed");
      }
    }

    async function getCount(candidate) {
      if (!contract) return 0;
      const n = await contract.getVotes(candidate);
      return n.toString();
    }

    async function updateCounts(id) {
      const fav = await getCount(key(id, "Favour"));
      const ag = await getCount(key(id, "Against"));
      document.getElementById("counts-" + id).textContent = `Favour: ${fav} | Against: ${ag}`;
    }

    async function renderAllCounts() {
      for (const t of TENDERS) await updateCounts(t.id);
    }
  </script>
</body>
</html>
